<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Footing Design Pro | Pang-Masa Engineering</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
            color: #fff;
            min-height: 100vh;
        }

        .header {
            background: rgba(20, 20, 30, 0.95);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .logo h1 {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .logo h1 span {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .app-container {
            display: grid;
            grid-template-columns: 350px 1fr 350px;
            gap: 20px;
            padding: 20px;
            height: calc(100vh - 70px);
        }

        .panel {
            background: rgba(20, 20, 30, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
        }

        .panel-header {
            font-size: 0.85rem;
            font-weight: 600;
            color: #ff6b35;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .param-group {
            margin-bottom: 20px;
        }

        .param-group h3 {
            font-size: 0.75rem;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .param-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .param-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .param-item label {
            font-size: 0.75rem;
            color: #8b949e;
        }

        .param-item input,
        .param-item select {
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #fff;
            font-size: 0.9rem;
        }

        .param-item input:focus {
            outline: none;
            border-color: #ff6b35;
        }

        .canvas-area {
            display: flex;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            overflow: hidden;
        }

        .canvas-tabs {
            display: flex;
            background: rgba(20, 20, 30, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .canvas-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #8b949e;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .canvas-tab.active {
            color: #fff;
            background: rgba(255, 107, 53, 0.2);
            border-bottom: 2px solid #ff6b35;
        }

        .canvas-wrapper {
            flex: 1;
            position: relative;
        }

        #footingCanvas {
            width: 100%;
            height: 100%;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 107, 53, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .result-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .result-card h4 {
            font-size: 0.7rem;
            color: #8b949e;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .result-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ff6b35;
        }

        .result-unit {
            font-size: 0.8rem;
            color: #8b949e;
        }

        .check-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .check-label {
            font-size: 0.85rem;
            color: #ccc;
        }

        .check-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .check-ok {
            background: rgba(0, 200, 100, 0.2);
            color: #00c864;
        }

        .check-fail {
            background: rgba(255, 100, 100, 0.2);
            color: #ff6464;
        }

        .rebar-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        .rebar-table th,
        .rebar-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .rebar-table th {
            color: #8b949e;
            font-weight: 500;
        }

        .formula-box {
            background: rgba(0, 0, 0, 0.4);
            border-left: 3px solid #ff6b35;
            padding: 10px 12px;
            margin: 10px 0;
            font-family: 'Consolas', monospace;
            font-size: 0.75rem;
            color: #aaa;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .status-ok {
            background: linear-gradient(135deg, rgba(0, 200, 100, 0.2), rgba(0, 150, 100, 0.2));
            color: #00c864;
            border: 1px solid rgba(0, 200, 100, 0.3);
        }

        .status-fail {
            background: linear-gradient(135deg, rgba(255, 100, 100, 0.2), rgba(200, 50, 50, 0.2));
            color: #ff6464;
            border: 1px solid rgba(255, 100, 100, 0.3);
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="logo">
            <div class="logo-icon">üèóÔ∏è</div>
            <h1>Footing <span>Design Pro</span></h1>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" onclick="loadFromTributary()" style="width: auto; padding: 8px 16px;">üì•
                Load from Tributary Pro</button>
            <button class="btn" onclick="exportDesign()" style="width: auto; padding: 8px 16px;">üì§ Export
                Design</button>
        </div>
    </div>

    <!-- Navigation Bar -->
    <nav
        style="background: rgba(10,10,15,0.95); padding: 8px 20px; display: flex; gap: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); flex-wrap: wrap;">
        <a href="tributary_pro.html"
            style="padding: 6px 14px; background: rgba(255,255,255,0.1); border-radius: 6px; color: #aaa; text-decoration: none; font-size: 0.8rem;">üìê
            Tributary Pro</a>
        <a href="frame_viewer_3d.html"
            style="padding: 6px 14px; background: rgba(255,255,255,0.1); border-radius: 6px; color: #aaa; text-decoration: none; font-size: 0.8rem;">üèóÔ∏è
            3D Viewer</a>
        <a href="footing_design.html"
            style="padding: 6px 14px; background: linear-gradient(135deg, #ff6b35, #f7931e); border-radius: 6px; color: #fff; text-decoration: none; font-size: 0.8rem; font-weight: 600;">üî≥
            Footing Design</a>
        <a href="foundation_plan.html"
            style="padding: 6px 14px; background: rgba(255,255,255,0.1); border-radius: 6px; color: #aaa; text-decoration: none; font-size: 0.8rem;">üìã
            Foundation Plan</a>
        <a href="calculation_sheet.html"
            style="padding: 6px 14px; background: rgba(255,255,255,0.1); border-radius: 6px; color: #aaa; text-decoration: none; font-size: 0.8rem;">üìÑ
            Calc Sheet</a>
        <a href="structural_analysis.html"
            style="padding: 6px 14px; background: rgba(255,255,255,0.1); border-radius: 6px; color: #aaa; text-decoration: none; font-size: 0.8rem;">‚ö°
            Analysis</a>
        <span style="flex: 1;"></span>
        <span style="color: #8b949e; font-size: 0.7rem; align-self: center;">üöÄ Pang-Masa Engineering Suite v0.1</span>
    </nav>

    <div class="app-container">
        <!-- Left Panel - Inputs -->
        <div class="panel">
            <div class="panel-header">üìê Design Parameters</div>

            <div class="param-group">
                <h3>üèõÔ∏è Column Data</h3>
                <div
                    style="margin-bottom: 10px; padding: 8px; background: rgba(0,212,255,0.1); border-radius: 6px; border-left: 3px solid #00d4ff;">
                    <label style="font-size: 0.75rem; color: #8b949e;">Select Column from Tributary Pro</label>
                    <select id="columnSelect" onchange="onColumnSelect()"
                        style="width: 100%; margin-top: 4px; padding: 10px; background: rgba(0,0,0,0.4); border: 1px solid #00d4ff; border-radius: 6px; color: #fff; font-size: 0.9rem;">
                        <option value="">-- Load columns from Tributary Pro --</option>
                    </select>
                </div>
                <div class="param-grid">
                    <div class="param-item">
                        <label>Column ID</label>
                        <input type="text" id="columnId" value="A1" readonly style="background: rgba(100,100,100,0.3);">
                    </div>
                    <div class="param-item">
                        <label>Axial Load Pu (kN)</label>
                        <input type="number" id="axialLoad" value="500" step="10" onchange="calculate()">
                    </div>
                    <div class="param-item">
                        <label>Column Width (mm)</label>
                        <input type="number" id="colWidth" value="400" step="50" onchange="calculate()">
                    </div>
                    <div class="param-item">
                        <label>Column Depth (mm)</label>
                        <input type="number" id="colDepth" value="400" step="50" onchange="calculate()">
                    </div>
                </div>
            </div>

            <div class="param-group">
                <h3>üåç Site Conditions</h3>
                <div class="param-grid">
                    <div class="param-item" style="grid-column: span 2;">
                        <label>Soil Bearing Capacity qa (kPa)</label>
                        <input type="number" id="soilCapacity" value="100" step="10" onchange="calculate()">
                    </div>
                    <div class="param-item">
                        <label>Depth to Footing (m)</label>
                        <input type="number" id="depthToFooting" value="1.5" step="0.1" onchange="calculate()">
                    </div>
                    <div class="param-item">
                        <label>Water Table (m)</label>
                        <input type="number" id="waterTable" value="3.0" step="0.1">
                    </div>
                </div>
            </div>

            <div class="param-group">
                <h3>üî© Material Properties</h3>
                <div class="param-grid">
                    <div class="param-item">
                        <label>f'c (MPa)</label>
                        <input type="number" id="fc" value="21" step="1" onchange="calculate()">
                    </div>
                    <div class="param-item">
                        <label>fy (MPa)</label>
                        <input type="number" id="fy" value="275" step="5" onchange="calculate()">
                    </div>
                    <div class="param-item">
                        <label>Rebar Size</label>
                        <select id="rebarSize" onchange="calculate()">
                            <option value="12">12mm</option>
                            <option value="16" selected>16mm</option>
                            <option value="20">20mm</option>
                            <option value="25">25mm</option>
                        </select>
                    </div>
                    <div class="param-item">
                        <label>Cover (mm)</label>
                        <input type="number" id="cover" value="75" step="5" onchange="calculate()">
                    </div>
                </div>
            </div>

            <div class="param-group">
                <h3>üìè Footing Geometry</h3>
                <div class="param-grid">
                    <div class="param-item">
                        <label>Type</label>
                        <select id="footingType" onchange="calculate()">
                            <option value="square">Square</option>
                            <option value="rectangular">Rectangular</option>
                        </select>
                    </div>
                    <div class="param-item">
                        <label>Length L (m)</label>
                        <input type="number" id="footingL" value="2.0" step="0.1" onchange="calculate()">
                    </div>
                    <div class="param-item">
                        <label>Width B (m)</label>
                        <input type="number" id="footingB" value="2.0" step="0.1" onchange="calculate()">
                    </div>
                    <div class="param-item">
                        <label>Thickness h (mm)</label>
                        <input type="number" id="footingH" value="450" step="50" onchange="calculate()">
                    </div>
                </div>
            </div>

            <button class="btn" onclick="autoSize()">üîÑ Auto-Size Footing</button>
            <button class="btn btn-secondary" onclick="calculate()">üìä Calculate</button>
        </div>

        <!-- Center - Canvas -->
        <div class="canvas-area">
            <div class="canvas-tabs">
                <button class="canvas-tab active" onclick="setView('plan')">Plan View</button>
                <button class="canvas-tab" onclick="setView('section')">Section View</button>
                <button class="canvas-tab" onclick="setView('rebar')">Rebar Detail</button>
            </div>
            <div class="canvas-wrapper">
                <canvas id="footingCanvas"></canvas>
            </div>
        </div>

        <!-- Right Panel - Results -->
        <div class="panel">
            <div class="panel-header">üìä Design Results</div>

            <div id="overallStatus" class="status-badge status-ok">‚úÖ DESIGN OK</div>

            <div class="result-card">
                <h4>Required Footing Area</h4>
                <span class="result-value" id="reqArea">0</span>
                <span class="result-unit">m¬≤</span>
            </div>

            <div class="result-card">
                <h4>Provided Footing Area</h4>
                <span class="result-value" id="provArea">0</span>
                <span class="result-unit">m¬≤ (L √ó B)</span>
            </div>

            <div class="result-card">
                <h4>Soil Pressure</h4>
                <span class="result-value" id="soilPressure">0</span>
                <span class="result-unit">kPa &lt; qa</span>
            </div>

            <div style="margin-top: 20px;">
                <div class="panel-header">‚úÖ Design Checks</div>

                <div class="check-row">
                    <span class="check-label">Bearing Capacity</span>
                    <span class="check-status check-ok" id="checkBearing">OK</span>
                </div>
                <div class="check-row">
                    <span class="check-label">Punching Shear</span>
                    <span class="check-status check-ok" id="checkPunching">OK</span>
                </div>
                <div class="check-row">
                    <span class="check-label">One-Way Shear (X)</span>
                    <span class="check-status check-ok" id="checkShearX">OK</span>
                </div>
                <div class="check-row">
                    <span class="check-label">One-Way Shear (Y)</span>
                    <span class="check-status check-ok" id="checkShearY">OK</span>
                </div>
                <div class="check-row">
                    <span class="check-label">Flexure (X)</span>
                    <span class="check-status check-ok" id="checkFlexX">OK</span>
                </div>
                <div class="check-row">
                    <span class="check-label">Flexure (Y)</span>
                    <span class="check-status check-ok" id="checkFlexY">OK</span>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <div class="panel-header">üî© Reinforcement</div>

                <table class="rebar-table">
                    <thead>
                        <tr>
                            <th>Direction</th>
                            <th>Bars</th>
                            <th>Spacing</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Bottom X</td>
                            <td id="rebarX">10-16mm</td>
                            <td id="spacingX">200mm c/c</td>
                        </tr>
                        <tr>
                            <td>Bottom Y</td>
                            <td id="rebarY">10-16mm</td>
                            <td id="spacingY">200mm c/c</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 20px;">
                <div class="panel-header">üì¶ Quantities</div>

                <div class="check-row">
                    <span class="check-label">Concrete Volume</span>
                    <span id="concreteVol" style="color: #ff6b35;">0.00 m¬≥</span>
                </div>
                <div class="check-row">
                    <span class="check-label">Rebar Weight</span>
                    <span id="rebarWeight" style="color: #ff6b35;">0.00 kg</span>
                </div>
                <div class="check-row">
                    <span class="check-label">Excavation</span>
                    <span id="excavation" style="color: #ff6b35;">0.00 m¬≥</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let canvas, ctx;
        let currentView = 'plan';
        let design = {};

        document.addEventListener('DOMContentLoaded', () => {
            canvas = document.getElementById('footingCanvas');
            ctx = canvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            calculate();
        });

        function resizeCanvas() {
            const wrapper = canvas.parentElement;
            canvas.width = wrapper.clientWidth;
            canvas.height = wrapper.clientHeight;
            draw();
        }

        function setView(view) {
            currentView = view;
            document.querySelectorAll('.canvas-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            draw();
        }

        function calculate() {
            // Get inputs
            const Pu = parseFloat(document.getElementById('axialLoad').value) || 500;
            const qa = parseFloat(document.getElementById('soilCapacity').value) || 100;
            const fc = parseFloat(document.getElementById('fc').value) || 21;
            const fy = parseFloat(document.getElementById('fy').value) || 275;
            const L = parseFloat(document.getElementById('footingL').value) || 2.0;
            const B = parseFloat(document.getElementById('footingB').value) || 2.0;
            const h = parseFloat(document.getElementById('footingH').value) || 450;
            const cover = parseFloat(document.getElementById('cover').value) || 75;
            const rebarDia = parseFloat(document.getElementById('rebarSize').value) || 16;
            const colW = parseFloat(document.getElementById('colWidth').value) || 400;
            const colD = parseFloat(document.getElementById('colDepth').value) || 400;

            // Convert to consistent units (m, kN, MPa)
            const h_m = h / 1000;
            const d = (h - cover - rebarDia / 2) / 1000; // Effective depth in m
            const colW_m = colW / 1000;
            const colD_m = colD / 1000;

            // 1. Required Area
            const Areq = Pu / qa;
            document.getElementById('reqArea').textContent = Areq.toFixed(2);

            // 2. Provided Area
            const Aprov = L * B;
            document.getElementById('provArea').textContent = Aprov.toFixed(2);

            // 3. Soil Pressure
            const qu = Pu / Aprov;
            document.getElementById('soilPressure').textContent = qu.toFixed(1);

            // Store for drawing
            design = { Pu, qa, fc, fy, L, B, h: h_m, d, cover: cover / 1000, rebarDia, colW: colW_m, colD: colD_m, qu, Areq, Aprov };

            // 4. BEARING CHECK
            const bearingOK = qu <= qa;
            updateCheck('checkBearing', bearingOK, `${qu.toFixed(0)} < ${qa}`);

            // 5. PUNCHING SHEAR (Two-way shear)
            // Critical perimeter at d/2 from column face
            const bo = 2 * ((colW_m + d) + (colD_m + d));
            const Vu_punch = Pu - qu * (colW_m + d) * (colD_m + d);
            const vu_punch = Vu_punch / (bo * d * 1000); // MPa
            const vc_punch = 0.33 * Math.sqrt(fc); // ACI simplified
            const punchingOK = vu_punch <= vc_punch;
            updateCheck('checkPunching', punchingOK, `${vu_punch.toFixed(2)} < ${vc_punch.toFixed(2)} MPa`);
            design.punchingData = { bo, Vu_punch, vu_punch, vc_punch };

            // 6. ONE-WAY SHEAR X (Critical at d from column face)
            const x_crit = (L - colW_m) / 2 - d;
            const Vu_x = qu * B * x_crit;
            const vu_x = Vu_x / (B * d * 1000);
            const vc_1way = 0.17 * Math.sqrt(fc);
            const shearXOK = vu_x <= vc_1way;
            updateCheck('checkShearX', shearXOK, `${vu_x.toFixed(2)} < ${vc_1way.toFixed(2)} MPa`);

            // 7. ONE-WAY SHEAR Y
            const y_crit = (B - colD_m) / 2 - d;
            const Vu_y = qu * L * y_crit;
            const vu_y = Vu_y / (L * d * 1000);
            const shearYOK = vu_y <= vc_1way;
            updateCheck('checkShearY', shearYOK, `${vu_y.toFixed(2)} < ${vc_1way.toFixed(2)} MPa`);

            // 8. FLEXURE X (Cantilever from column face)
            const lx = (L - colW_m) / 2;
            const Mu_x = qu * B * lx * lx / 2; // kN¬∑m
            const Ru_x = Mu_x / (B * d * d * 1000); // MPa
            const rho_x = 0.85 * fc / fy * (1 - Math.sqrt(1 - 2 * Ru_x / (0.85 * fc)));
            const rho_min = Math.max(0.25 * Math.sqrt(fc) / fy, 1.4 / fy);
            const rho_use_x = Math.max(rho_x, rho_min);
            const As_x = rho_use_x * B * d * 1000000; // mm¬≤
            const flexXOK = !isNaN(rho_x) && rho_x < 0.025;
            updateCheck('checkFlexX', flexXOK, `œÅ = ${(rho_use_x * 100).toFixed(3)}%`);

            // 9. FLEXURE Y
            const ly = (B - colD_m) / 2;
            const Mu_y = qu * L * ly * ly / 2;
            const d_y = d - rebarDia / 1000; // Second layer
            const Ru_y = Mu_y / (L * d_y * d_y * 1000);
            const rho_y = 0.85 * fc / fy * (1 - Math.sqrt(1 - 2 * Ru_y / (0.85 * fc)));
            const rho_use_y = Math.max(rho_y, rho_min);
            const As_y = rho_use_y * L * d_y * 1000000; // mm¬≤
            const flexYOK = !isNaN(rho_y) && rho_y < 0.025;
            updateCheck('checkFlexY', flexYOK, `œÅ = ${(rho_use_y * 100).toFixed(3)}%`);

            // 10. REBAR DETAILS
            const barArea = Math.PI * rebarDia * rebarDia / 4;
            const nBarsX = Math.ceil(As_x / barArea);
            const spacingX = Math.floor((B * 1000 - 2 * cover) / (nBarsX - 1));
            const nBarsY = Math.ceil(As_y / barArea);
            const spacingY = Math.floor((L * 1000 - 2 * cover) / (nBarsY - 1));

            document.getElementById('rebarX').textContent = `${nBarsX}-${rebarDia}mm`;
            document.getElementById('spacingX').textContent = `${spacingX}mm c/c`;
            document.getElementById('rebarY').textContent = `${nBarsY}-${rebarDia}mm`;
            document.getElementById('spacingY').textContent = `${spacingY}mm c/c`;

            design.rebar = { nBarsX, nBarsY, spacingX, spacingY, As_x, As_y };

            // 11. QUANTITIES
            const concreteVol = L * B * h_m;
            const rebarLength = nBarsX * (B - 0.1) + nBarsY * (L - 0.1);
            const rebarWeight = rebarLength * (rebarDia * rebarDia / 162);
            const excavation = (L + 0.3) * (B + 0.3) * (parseFloat(document.getElementById('depthToFooting').value) || 1.5);

            document.getElementById('concreteVol').textContent = concreteVol.toFixed(2) + ' m¬≥';
            document.getElementById('rebarWeight').textContent = rebarWeight.toFixed(1) + ' kg';
            document.getElementById('excavation').textContent = excavation.toFixed(2) + ' m¬≥';

            // 12. OVERALL STATUS
            const allOK = bearingOK && punchingOK && shearXOK && shearYOK && flexXOK && flexYOK;
            const statusEl = document.getElementById('overallStatus');
            if (allOK) {
                statusEl.className = 'status-badge status-ok';
                statusEl.textContent = '‚úÖ DESIGN OK';
            } else {
                statusEl.className = 'status-badge status-fail';
                statusEl.textContent = '‚ùå DESIGN FAILS - Increase Size';
            }

            draw();
        }

        function updateCheck(id, ok, detail) {
            const el = document.getElementById(id);
            el.className = ok ? 'check-status check-ok' : 'check-status check-fail';
            el.textContent = ok ? 'OK' : 'FAIL';
            el.title = detail;
        }

        function autoSize() {
            const Pu = parseFloat(document.getElementById('axialLoad').value) || 500;
            const qa = parseFloat(document.getElementById('soilCapacity').value) || 100;

            // Required area with 10% increase
            const Areq = Pu / qa * 1.1;

            // For square footing
            const side = Math.ceil(Math.sqrt(Areq) * 10) / 10;

            document.getElementById('footingL').value = side.toFixed(1);
            document.getElementById('footingB').value = side.toFixed(1);

            // Auto thickness (rough estimate: h ‚âà L/4 to L/5)
            const h = Math.max(300, Math.ceil(side * 200));
            document.getElementById('footingH').value = Math.ceil(h / 50) * 50;

            calculate();
        }

        function draw() {
            if (!ctx) return;
            ctx.fillStyle = '#0a0a0f';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (currentView === 'plan') drawPlan();
            else if (currentView === 'section') drawSection();
            else if (currentView === 'rebar') drawRebar();
        }

        function drawPlan() {
            const { L, B, colW, colD, d, cover, rebar } = design;
            if (!L) return;

            const scale = Math.min((canvas.width - 100) / (L * 1000), (canvas.height - 100) / (B * 1000)) * 0.8;
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;

            // Footing outline
            const fW = L * 1000 * scale;
            const fH = B * 1000 * scale;

            ctx.strokeStyle = '#ff6b35';
            ctx.lineWidth = 3;
            ctx.strokeRect(cx - fW / 2, cy - fH / 2, fW, fH);

            // Fill
            ctx.fillStyle = 'rgba(255, 107, 53, 0.1)';
            ctx.fillRect(cx - fW / 2, cy - fH / 2, fW, fH);

            // Column outline
            const cW = colW * 1000 * scale;
            const cH = colD * 1000 * scale;
            ctx.fillStyle = 'rgba(100, 100, 100, 0.8)';
            ctx.fillRect(cx - cW / 2, cy - cH / 2, cW, cH);
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 2;
            ctx.strokeRect(cx - cW / 2, cy - cH / 2, cW, cH);

            // Punching shear perimeter (d/2 from column)
            const punchD = d * 1000 * scale;
            ctx.setLineDash([5, 5]);
            ctx.strokeStyle = '#00d4ff';
            ctx.lineWidth = 2;
            ctx.strokeRect(cx - cW / 2 - punchD / 2, cy - cH / 2 - punchD / 2, cW + punchD, cH + punchD);
            ctx.setLineDash([]);

            // Critical shear section (d from column)
            ctx.strokeStyle = '#00c853';
            ctx.setLineDash([8, 4]);
            ctx.strokeRect(cx - cW / 2 - punchD, cy - cH / 2 - punchD, cW + punchD * 2, cH + punchD * 2);
            ctx.setLineDash([]);

            // Dimensions
            ctx.fillStyle = '#fff';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`${(L * 1000).toFixed(0)} mm`, cx, cy + fH / 2 + 30);

            ctx.save();
            ctx.translate(cx - fW / 2 - 30, cy);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText(`${(B * 1000).toFixed(0)} mm`, 0, 0);
            ctx.restore();

            // Legend
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillStyle = '#ff6b35';
            ctx.fillText('‚îÅ Footing', 20, 30);
            ctx.fillStyle = '#00d4ff';
            ctx.fillText('‚îÖ Punching perimeter (d/2)', 20, 50);
            ctx.fillStyle = '#00c853';
            ctx.fillText('‚îÖ Shear section (d)', 20, 70);
        }

        function drawSection() {
            const { L, B, h, d, colW, colD, cover } = design;
            if (!L) return;

            const scale = Math.min((canvas.width - 150) / (L * 1000), (canvas.height - 150) / (h * 1000 * 3));
            const cx = canvas.width / 2;
            const groundY = canvas.height * 0.3;

            // Ground line
            ctx.strokeStyle = '#555';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(50, groundY);
            ctx.lineTo(canvas.width - 50, groundY);
            ctx.stroke();

            // Hatch for soil
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            for (let x = 50; x < canvas.width - 50; x += 20) {
                ctx.beginPath();
                ctx.moveTo(x, groundY);
                ctx.lineTo(x + 10, groundY - 15);
                ctx.stroke();
            }

            // Footing
            const fW = L * 1000 * scale;
            const fH = h * 1000 * scale;
            const footingTop = groundY + 50;

            ctx.fillStyle = 'rgba(255, 107, 53, 0.3)';
            ctx.fillRect(cx - fW / 2, footingTop, fW, fH);
            ctx.strokeStyle = '#ff6b35';
            ctx.lineWidth = 3;
            ctx.strokeRect(cx - fW / 2, footingTop, fW, fH);

            // Column rising from footing
            const cW = colW * 1000 * scale;
            const colHeight = 100;
            ctx.fillStyle = 'rgba(100, 100, 100, 0.8)';
            ctx.fillRect(cx - cW / 2, footingTop - colHeight, cW, colHeight);
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 2;
            ctx.strokeRect(cx - cW / 2, footingTop - colHeight, cW, colHeight);

            // Rebar dots
            const rebarR = 4;
            ctx.fillStyle = '#00d4ff';
            const nBars = design.rebar ? design.rebar.nBarsX : 5;
            const spacing = fW / (nBars + 1);
            for (let i = 1; i <= nBars; i++) {
                ctx.beginPath();
                ctx.arc(cx - fW / 2 + spacing * i, footingTop + fH - cover * 1000 * scale - rebarR, rebarR, 0, Math.PI * 2);
                ctx.fill();
            }

            // Dimensions
            ctx.fillStyle = '#fff';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`h = ${(h * 1000).toFixed(0)} mm`, cx + fW / 2 + 50, footingTop + fH / 2);
            ctx.fillText(`d = ${(d * 1000).toFixed(0)} mm`, cx - fW / 2 - 50, footingTop + fH - cover * 1000 * scale);
            ctx.fillText(`L = ${(L * 1000).toFixed(0)} mm`, cx, footingTop + fH + 30);
        }

        function drawRebar() {
            const { L, B, cover, rebar, h } = design;
            if (!L || !rebar) return;

            const scale = Math.min((canvas.width - 100) / (L * 1000), (canvas.height - 100) / (B * 1000)) * 0.7;
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;

            const fW = L * 1000 * scale;
            const fH = B * 1000 * scale;
            const covS = cover * 1000 * scale;

            // Footing outline (faded)
            ctx.strokeStyle = 'rgba(255, 107, 53, 0.3)';
            ctx.lineWidth = 2;
            ctx.strokeRect(cx - fW / 2, cy - fH / 2, fW, fH);

            // X-direction bars (bottom layer, along L)
            ctx.strokeStyle = '#00d4ff';
            ctx.lineWidth = 3;
            const nX = rebar.nBarsX;
            const spX = (fH - 2 * covS) / (nX - 1);
            for (let i = 0; i < nX; i++) {
                const y = cy - fH / 2 + covS + i * spX;
                ctx.beginPath();
                ctx.moveTo(cx - fW / 2 + covS, y);
                ctx.lineTo(cx + fW / 2 - covS, y);
                ctx.stroke();
            }

            // Y-direction bars (top of bottom layer, along B)
            ctx.strokeStyle = '#00c853';
            ctx.lineWidth = 3;
            const nY = rebar.nBarsY;
            const spY = (fW - 2 * covS) / (nY - 1);
            for (let i = 0; i < nY; i++) {
                const x = cx - fW / 2 + covS + i * spY;
                ctx.beginPath();
                ctx.moveTo(x, cy - fH / 2 + covS);
                ctx.lineTo(x, cy + fH / 2 - covS);
                ctx.stroke();
            }

            // Legend
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillStyle = '#00d4ff';
            ctx.fillText(`‚îÅ Bottom X: ${nX}-${document.getElementById('rebarSize').value}mm @ ${rebar.spacingX}mm c/c`, 20, 30);
            ctx.fillStyle = '#00c853';
            ctx.fillText(`‚îÅ Bottom Y: ${nY}-${document.getElementById('rebarSize').value}mm @ ${rebar.spacingY}mm c/c`, 20, 50);

            // Total As
            ctx.fillStyle = '#fff';
            ctx.fillText(`As,x = ${rebar.As_x.toFixed(0)} mm¬≤`, 20, 80);
            ctx.fillText(`As,y = ${rebar.As_y.toFixed(0)} mm¬≤`, 20, 100);
        }

        // Store columns data
        let tributaryColumns = [];

        function loadFromTributary() {
            const saved = localStorage.getItem('tributaryProColumns');
            if (!saved) {
                alert('No column data found!\\n\\nTo sync columns:\\n1. Open Tributary Pro\\n2. Set up your grid\\n3. The columns will auto-sync here!');
                return;
            }

            try {
                const data = JSON.parse(saved);
                tributaryColumns = data.columns || [];

                // Populate dropdown
                const select = document.getElementById('columnSelect');
                select.innerHTML = '<option value="">-- Select a column (' + tributaryColumns.length + ' available) --</option>';

                for (let col of tributaryColumns) {
                    if (!col.enabled) continue; // Skip disabled columns
                    const option = document.createElement('option');
                    option.value = col.id;
                    option.textContent = `${col.id} - ${col.totalLoad.toFixed(0)} kN (${col.tribArea.toFixed(1)} m¬≤)`;
                    select.appendChild(option);
                }

                // Also update soil capacity if provided
                if (data.soilCapacity) {
                    document.getElementById('soilCapacity').value = data.soilCapacity;
                }

                alert('‚úÖ Loaded ' + tributaryColumns.filter(c => c.enabled).length + ' columns from Tributary Pro!');
            } catch (e) {
                console.error(e);
                alert('Error loading column data: ' + e.message);
            }
        }

        function onColumnSelect() {
            const select = document.getElementById('columnSelect');
            const colId = select.value;

            if (!colId) return;

            // Find column data
            const col = tributaryColumns.find(c => c.id === colId);
            if (!col) return;

            // Populate form
            document.getElementById('columnId').value = col.id;
            document.getElementById('axialLoad').value = col.totalLoad.toFixed(0);

            // Auto-size footing
            autoSize();
        }

        // Try to auto-load on page start
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const saved = localStorage.getItem('tributaryProColumns');
                if (saved) {
                    loadFromTributary();
                }
            }, 500);
        });

        // Listen for live updates from Tributary Pro
        window.addEventListener('storage', (e) => {
            if (e.key === 'tributaryProColumns') {
                console.log('Columns updated from Tributary Pro!');
                loadFromTributary();
            }
        });

        function exportDesign() {
            const columnId = document.getElementById('columnId').value;
            let report = `FOOTING DESIGN REPORT\n`;
            report += `=====================\n\n`;
            report += `Column: ${columnId}\n`;
            report += `Axial Load: ${document.getElementById('axialLoad').value} kN\n\n`;

            report += `FOOTING GEOMETRY\n`;
            report += `Length: ${design.L * 1000} mm\n`;
            report += `Width: ${design.B * 1000} mm\n`;
            report += `Thickness: ${design.h * 1000} mm\n\n`;

            report += `REINFORCEMENT\n`;
            report += `Bottom X: ${design.rebar.nBarsX}-${document.getElementById('rebarSize').value}mm @ ${design.rebar.spacingX}mm c/c\n`;
            report += `Bottom Y: ${design.rebar.nBarsY}-${document.getElementById('rebarSize').value}mm @ ${design.rebar.spacingY}mm c/c\n\n`;

            report += `QUANTITIES\n`;
            report += `Concrete: ${(design.L * design.B * design.h).toFixed(2)} m¬≥\n`;
            report += `Rebar: ${document.getElementById('rebarWeight').textContent}\n`;

            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `footing_${columnId}.txt`;
            a.click();
        }
    </script>
</body>

</html>