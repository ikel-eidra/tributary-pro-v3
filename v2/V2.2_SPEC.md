# ðŸ“Œ Tributary Pro v2.2 - Corrected 2-Way Areas per Beam

**From:** Lum
**Date:** December 16, 2025
**Status:** Pending Implementation

---

## ðŸŽ¯ Target Behavior

* Keep **v2.0 numeric behavior** (short/long span 2-way logic)
* Keep v2.1's **triangular visuals** (clean look)
* Each triangle's **A and w** reflects the **actual tributary share** per beam

> **KEY INSIGHT:** Short span direction gets MORE load (stiffer = carries more)
> Not: longer beam = more w. Wrong!

---

## 1. Beam Data Structure: Add "slices"

```javascript
beam.slices = [];  // one entry per adjacent slab
// Each slice:
{
  slabId: string,
  side: 'top' | 'bottom' | 'left' | 'right',
  area: number,          // mÂ² from math
  w: number,             // kN/m from math
  poly: [{x,y},...],     // simple triangle for drawing
  cx: number, cy: number // centroid (display only)
}
```

---

## 2. Use Original v2.0 Math for Tributary Areas

```javascript
const lx = slab.lx; // span in X
const ly = slab.ly; // span in Y
const triHeight = Math.min(lx, ly) / 2;

// X-beams (top/bottom):
const A_x_side = lx * triHeight / 2;

// Y-beams (left/right):
const trapBase = ly;
const trapTop = ly - 2*triHeight;
const A_y_side_raw = trapTop > 0
    ? (trapBase + trapTop) * triHeight / 2  // trapezoid
    : ly * triHeight / 2;                   // triangle

// Normalize
const rawTotal = 2*A_x_side + 2*A_y_side_raw;
const scale = slab.area / rawTotal;

const A_top    = A_x_side * scale;
const A_bottom = A_x_side * scale;
const A_left   = A_y_side_raw * scale;
const A_right  = A_y_side_raw * scale;
```

**Result:** `A_top + A_bottom + A_left + A_right = slab.area`
But X and Y get DIFFERENT shares when `lx â‰  ly`!

---

## 3. Assign Triangle Geometry per Slice

```javascript
function assignSlicePolygon(slab, slice) {
  const x0 = slab.x1, x1 = slab.x2;
  const y0 = slab.y1, y1 = slab.y2;
  const cx_mid = (x0 + x1)/2;
  const cy_mid = (y0 + y1)/2;

  let poly;
  if (slice.side === 'top') {
    poly = [{ x: x0, y: y0 }, { x: x1, y: y0 }, { x: cx_mid, y: cy_mid }];
  } else if (slice.side === 'bottom') {
    poly = [{ x: x0, y: y1 }, { x: x1, y: y1 }, { x: cx_mid, y: cy_mid }];
  } else if (slice.side === 'left') {
    poly = [{ x: x0, y: y0 }, { x: x0, y: y1 }, { x: cx_mid, y: cy_mid }];
  } else if (slice.side === 'right') {
    poly = [{ x: x1, y: y0 }, { x: x1, y: y1 }, { x: cx_mid, y: cy_mid }];
  }

  const { area, cx, cy } = computePolygonAreaAndCentroid(poly);
  slice.poly = poly;
  slice.cx = cx;
  slice.cy = cy;
}
```

---

## 4. Drawing & Labels (Areas Mode)

- Draw `slice.poly` with low opacity
- At `(slice.cx, slice.cy)` show:
  ```
  A = X.X mÂ²
  w = Y.Y kN/m
  ```
- Selected beam highlights only its slices

---

## Key Difference from v2.1

| v2.1 | v2.2 |
|------|------|
| Equal triangles (Â¼ each) | Proper 45Â° math |
| Same A for all sides | Short span gets MORE |
| Symmetric visuals + numbers | Symmetric visuals, ASYMMETRIC numbers |

---

**Send to Kira:**
> "v2.2 fix: restore realistic 2-way tributary math per beam. Visuals may be symmetric but numbers must follow the 45Â° method + normalization."
