<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tributary Pro v3.0 | Structural Load Analysis</title>
    <link rel="stylesheet" href="./styles/main.css">

    <!-- v2.4: Three.js for 3D View -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>

<body>
    <!-- ========== HEADER ========== -->
    <header class="header">
        <!-- Hamburger Menu (Settings) + Title - TOGETHER on LEFT -->
        <div style="display: flex; align-items: center; gap: 8px; position: relative;">
            <button class="tool-btn settings-gear" onclick="toggleDropdown()" title="Menu">
                ☰
            </button>
            <!-- Dropdown Menu -->
            <div id="settingsDropdown" class="settings-dropdown hidden">
                <div class="menu-item-header">THEME</div>
                <button id="themeBtn-midnight" class="menu-item"
                    onclick="setTheme('dark'); toggleDropdown()">Midnight</button>
                <button id="themeBtn-papermatte" class="menu-item"
                    onclick="setTheme('blueprint'); toggleDropdown()">Paper Matte</button>
                <div style="height:1px; background:#ddd; margin:4px 0; opacity:0.3;"></div>
                <button class="menu-item" onclick="resetProject(); toggleDropdown()">New Project</button>
                <button class="menu-item" onclick="saveProject(); toggleDropdown()">Save JSON</button>
            </div>

            <span style="font-weight: 600; font-size: 1rem; color: #000000; text-transform: uppercase;">TRIBUTARY PRO
                <span style="font-weight: 400;">v3.0</span></span>
        </div>
        <div class="header-actions">
            <button class="tool-btn" onclick="calculate()">Calculate</button>
            <button class="tool-btn" id="addBeamBtn" onclick="toggleBeamMode()"
                title="Click to add framing beam, then click-drag on canvas">Add Beam</button>
            <button class="tool-btn" onclick="exportResults()">Report</button>
            <button class="tool-btn" onclick="exportToSTAAD()">STAAD</button>
            <button class="tool-btn" onclick="exportToETABS()">ETABS</button>
            <button class="tool-btn" onclick="copySTAADToClipboard()"
                title="Copy STAAD code to clipboard (if download fails)">Copy</button>
            <button class="tool-btn" onclick="exportToDXF()" title="Export 2D plan to AutoCAD DXF">DXF</button>
            <button class="tool-btn" onclick="resetProject()"
                title="Reset to default values (new project)">Reset</button>
            <button class="tool-btn" onclick="refreshView()" title="Refresh calculations and redraw">Refresh</button>
        </div>
    </header>

    <!-- ========== MAIN LAYOUT ========== -->
    <div class="app-container">
        <!-- ========== LEFT PANEL: INPUTS ========== -->
        <div class="panel">
            <div class="panel-header">Input Parameters</div>

            <!-- Grid Spans -->
            <div class="param-group">
                <h3>X-Direction Spans (m)</h3>
                <div id="xSpansContainer" class="span-container"></div>
                <button class="add-span-btn" onclick="addSpan('x')">+ Add X Span</button>
            </div>

            <div class="param-group">
                <h3>Y-Direction Spans (m)</h3>
                <div id="ySpansContainer" class="span-container"></div>
                <button class="add-span-btn" onclick="addSpan('y')">+ Add Y Span</button>
            </div>

            <!-- v2.3: Floor Tabs -->
            <div class="floor-tabs-container">
                <div class="floor-tabs-header">
                    <h4>Floors</h4>
                </div>
                <div class="floor-tabs" id="floorTabs">
                    <!-- Dynamically populated -->
                </div>
                <div style="display: flex; gap: 4px; margin-top: 8px;">
                    <button class="add-floor-btn" onclick="addFloor()">+ Add Floor</button>
                    <button class="remove-floor-btn" onclick="removeFloor()">− Remove</button>
                </div>

                <!-- v2.6: GF Checkbox (suspended slabs start from 2F) -->
                <div style="margin-top: 10px; padding: 8px; background: rgba(255,193,7,0.1); border-radius: 6px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.75rem;">
                        <input type="checkbox" id="gfSuspended" onchange="toggleGFSuspended()">
                        <span>GF Suspended (elevated house)</span>
                    </label>
                    <!-- Elevation Height - visible when GF Suspended is checked -->
                    <div id="elevationSection" style="display: none; margin-top: 8px;">
                        <label style="font-size: 0.65rem; color: #8b949e;">Elevation Height:</label>
                        <select id="elevationHeight" onchange="updateGFElevation(parseFloat(this.value)); calculate()"
                            style="width: 100%; padding: 4px; margin-top: 2px; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; color: white; font-size: 0.7rem;">
                            <option value="0.9">0.9 m</option>
                            <option value="1.0">1.0 m</option>
                            <option value="1.2" selected>1.2 m</option>
                            <option value="1.5">1.5 m</option>
                            <option value="1.8">1.8 m</option>
                        </select>
                    </div>
                    <div style="font-size: 0.65rem; color: #8b949e; margin-top: 4px;">
                        If unchecked, GF slab loads are excluded (typical for ground-bearing slabs)
                    </div>
                </div>

                <!-- v2.6: NSCP Building Type Preset -->
                <div style="margin-top: 10px;">
                    <label style="font-size: 0.7rem; color: #8b949e;">NSCP Building Type:</label>
                    <select id="buildingType" onchange="applyNSCPPreset()"
                        style="width: 100%; padding: 6px; margin-top: 4px; background: var(--surface); border: 1px solid var(--border); border-radius: 6px; color: white;">
                        <option value="residential">Residential (LL: 1.9 kPa)</option>
                        <option value="residential_heavy">Residential Heavy (LL: 2.4 kPa)</option>
                        <option value="office">Office (LL: 2.4 kPa)</option>
                        <option value="commercial">Commercial/Retail (LL: 4.8 kPa)</option>
                        <option value="school">School/Assembly (LL: 4.8 kPa)</option>
                        <option value="hospital">Hospital (LL: 3.8 kPa)</option>
                    </select>
                </div>

                <div class="floor-info" id="floorInfo">
                    <div class="floor-info-header">
                        <h5 id="currentFloorName">Ground Floor</h5>
                        <span class="floor-type-badge" id="floorTypeBadge">Typical</span>
                    </div>
                    <div class="param-grid">
                        <div class="param-item">
                            <label>DL Super (kPa) <span style="font-size:0.6rem;color:#f59e0b"
                                    title="Finishes, partitions, ceiling - NOT slab weight">ⓘ</span></label>
                            <input type="number" id="floorDL" value="2.0" step="0.5" min="0"
                                onchange="updateCurrentFloor()">
                        </div>
                        <div class="param-item">
                            <label>Live Load (kPa) <span style="font-size:0.6rem;color:#f59e0b"
                                    title="Can be higher for roof parties/water tanks">ⓘ</span></label>
                            <input type="number" id="floorLL" value="2.0" step="0.5" min="0"
                                onchange="updateCurrentFloor()">
                        </div>
                        <div class="param-item">
                            <label>Slab Thickness (mm)</label>
                            <input type="number" id="floorSlabThickness" value="150" step="10" min="100"
                                onchange="updateCurrentFloor()">
                        </div>
                        <div class="param-item">
                            <label>Height (m)</label>
                            <input type="number" id="floorHeight" value="3.0" step="0.1" min="2.5"
                                onchange="updateCurrentFloor()">
                        </div>
                        <div class="param-item">
                            <label>Wall Load (kN/m) <span style="font-size:0.6rem;color:#f59e0b"
                                    title="Line load for walls on beams (150mm CHB @3m ≈ 6.0)">ⓘ</span></label>
                            <input type="number" id="floorWallLoad" value="6.0" step="0.5" min="0"
                                onchange="updateCurrentFloor()">
                        </div>
                    </div>
                </div>
            </div>

            <!-- v3.0: Material Properties for Member Sizing -->
            <div class="param-group">
                <h3>Material & Member Sizing</h3>
                <div class="param-grid">
                    <div class="param-item">
                        <label>f'c (MPa)</label>
                        <select id="fcInput" onchange="state.fc = parseFloat(this.value); calculate();">
                            <option value="17">17 MPa</option>
                            <option value="21" selected>21 MPa</option>
                            <option value="24">24 MPa</option>
                            <option value="28">28 MPa</option>
                            <option value="35">35 MPa</option>
                        </select>
                    </div>
                    <div class="param-item">
                        <label>fy (MPa)</label>
                        <select id="fyInput" onchange="state.fy = parseFloat(this.value); calculate();">
                            <option value="275">Grade 40 (275)</option>
                            <option value="415" selected>Grade 60 (415)</option>
                        </select>
                    </div>
                </div>
                <div class="param-grid" style="margin-top: 8px;">
                    <div class="param-item">
                        <label>Column b (mm)</label>
                        <input type="number" id="columnWidthInput" value="0" min="0" max="600" step="50"
                            onchange="state.defaultColumnB = parseInt(this.value); calculate();"
                            title="0 = Auto (NSCP Pu sizing)">
                    </div>
                    <div class="param-item">
                        <label>Column h (mm)</label>
                        <input type="number" id="columnDepthInput" value="0" min="0" max="800" step="50"
                            onchange="state.defaultColumnH = parseInt(this.value); calculate();"
                            title="0 = Auto (same as b)">
                    </div>
                    <div class="param-item">
                        <label>Beam b (mm)</label>
                        <input type="number" id="beamWidthInput" value="250" min="200" max="500" step="25"
                            onchange="state.defaultBeamB = parseInt(this.value); calculate();">
                    </div>
                    <div class="param-item">
                        <label>Beam h (mm)</label>
                        <input type="number" id="beamDepthInput" value="0" min="0" max="800" step="50"
                            onchange="state.defaultBeamH = parseInt(this.value); calculate();"
                            title="0 = Auto (use L/16 rule)">
                    </div>
                </div>
                <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 4px;">
                    💡 Set to 0 for auto-sizing (NSCP rules). Column h=0 means square.
                </div>
            </div>

            <!-- v2.5: Footing Parameters -->
            <div class="param-group">
                <h3>Footing Parameters</h3>
                <div class="param-grid">
                    <div class="param-item">
                        <label>Depth (m)</label>
                        <select id="footingDepth" onchange="calculate()">
                            <option value="1.2">1.2 m</option>
                            <option value="1.5" selected>1.5 m</option>
                            <option value="1.8">1.8 m</option>
                        </select>
                    </div>
                    <div class="param-item">
                        <label>Soil Bearing (kPa)</label>
                        <input type="number" id="soilBearing" value="150" step="10" min="50" onchange="calculate()">
                    </div>
                </div>
            </div>

            <!-- v3.0: Cantilever Configuration -->
            <div class="param-group">
                <h3>Cantilevers (m)</h3>
                <div class="cantilever-section">
                    <div class="cantilever-edge">
                        <div class="cantilever-edge-header">
                            <label>↑ Top Edge</label>
                        </div>
                        <div class="cantilever-spans" id="cantileverTop"></div>
                    </div>
                    <div class="cantilever-edge">
                        <div class="cantilever-edge-header">
                            <label>→ Right Edge</label>
                        </div>
                        <div class="cantilever-spans" id="cantileverRight"></div>
                    </div>
                    <div class="cantilever-edge">
                        <div class="cantilever-edge-header">
                            <label>↓ Bottom Edge</label>
                        </div>
                        <div class="cantilever-spans" id="cantileverBottom"></div>
                    </div>
                    <div class="cantilever-edge">
                        <div class="cantilever-edge-header">
                            <label>← Left Edge</label>
                        </div>
                        <div class="cantilever-spans" id="cantileverLeft"></div>
                    </div>
                </div>
                <div style="font-size: 0.6rem; color: #8b949e; margin-top: 6px;">
                    Enter cantilever length per span (0 = no cantilever)
                </div>
            </div>

            <!-- Calculate Button -->
            <button class="action-btn" onclick="calculate()">
                Calculate Loads
            </button>

            <!-- v3.0: Save/Load Project Buttons -->
            <div style="display:flex;gap:6px;margin-top:8px;">
                <button class="tool-btn" onclick="saveProject()" style="flex:1;" title="Download project as JSON file">
                    Save
                </button>
                <button class="tool-btn" onclick="document.getElementById('loadProjectInput').click()" style="flex:1;"
                    title="Load project from JSON file">
                    Load
                </button>
                <input type="file" id="loadProjectInput" accept=".json" onchange="loadProject(event)"
                    style="display:none;">
            </div>

            <!-- v3.0: Export to Analysis Software -->
            <div class="param-group" style="margin-top: 12px; padding: 10px;">
                <h3 style="margin-bottom: 8px;">EXPORT TO ANALYSIS SOFTWARE</h3>
                <div style="display:flex;gap:6px;">
                    <button class="tool-btn" onclick="exportToSTAAD()" style="flex:1;"
                        title="Export to STAAD.Pro (.std file)">
                        STAAD
                    </button>
                    <button class="tool-btn" onclick="exportToETABS()" style="flex:1;"
                        title="Export to ETABS (.e2k file)">
                        ETABS
                    </button>
                </div>
                <div style="display:flex;gap:6px;margin-top:6px;">
                    <button class="tool-btn" onclick="copySTAADToClipboard()"
                        style="flex:1;font-size:0.65rem;padding:4px;" title="Copy STAAD code to clipboard">
                        COPY STAAD
                    </button>
                    <button class="tool-btn" onclick="copyETABSToClipboard()"
                        style="flex:1;font-size:0.65rem;padding:4px;" title="Copy ETABS code to clipboard">
                        COPY ETABS
                    </button>
                </div>

                <!-- v3.0: Universal BIM Export -->
                <div style="margin-top:8px;border-top:1px solid rgba(0,0,0,0.1);padding-top:8px;">
                    <div style="font-size:0.65rem;color:#000000;margin-bottom:4px;">UNIVERSAL BIM (REVIT, ARCHICAD,
                        TEKLA)</div>
                    <button class="tool-btn" onclick="exportToIFC()" style="width:100%;"
                        title="Export to IFC format for Revit, ArchiCAD, Tekla, and all BIM software">
                        EXPORT TO IFC (REVIT/BIM)
                    </button>
                </div>
            </div>

        </div>


        <!-- ========== CENTER: CANVAS ========== -->
        <div class="canvas-container">
            <div class="canvas-toolbar">
                <!-- v2.4: View Toggle -->
                <div class="view-toggle">
                    <button class="view-btn active" id="view2D" onclick="setView('2d')">2D Plan</button>
                    <button class="view-btn" id="view3D" onclick="setView('3d')">3D View</button>
                </div>

                <!-- v3.0: 2D Plan Tabs -->
                <div class="plan-tabs" id="planTabs">
                    <button class="plan-tab active" id="tabAnalysis" onclick="setPlanTab('analysis')">
                        Analysis</button>
                    <button class="plan-tab" id="tabStructural" onclick="setPlanTab('structural')">Structural
                        Plan</button>
                    <button class="plan-tab" id="tabFoundation" onclick="setPlanTab('foundation')">Foundation
                        Plan</button>
                </div>

                <!-- Layer Toggles (inspired by Sia's design) -->
                <div class="layer-toggles">
                    <button class="layer-btn active" id="layerGrid" onclick="toggleLayer('grid')">GRID</button>
                    <button class="layer-btn active" id="layerAreas" onclick="toggleLayer('areas')">Areas</button>
                    <button class="layer-btn active" id="layerBeams" onclick="toggleLayer('beams')">Beams</button>
                    <button class="layer-btn active" id="layerCols" onclick="toggleLayer('cols')">Cols</button>
                </div>

                <button class="tool-btn" id="panTool" onclick="togglePan()">Pan</button>
                <button class="tool-btn" onclick="zoomIn()">Zoom In</button>
                <button class="tool-btn" onclick="zoomOut()">Zoom Out</button>
                <button class="tool-btn" onclick="fitView()">Fit</button>
                <button class="tool-btn active" id="toggleAreas" onclick="toggleAreas()">Areas</button>
                <button class="tool-btn" id="toggleLabels" onclick="toggleLabels()">Labels</button>
                <button class="tool-btn" id="gridToggleBtn" onclick="toggleSubGrid()" title="Show 1m gridlines">
                    Grid</button>
                <button class="tool-btn" id="addCustomBeamBtn" onclick="showCustomBeamDialog()"
                    title="Add framing beam via dialog (gridline-based)">Stair Beam</button>
                <button class="tool-btn" id="addPlantedColBtn" onclick="togglePlantedColumnMode(event)"
                    title="Click to select beam for planted column. Shift+Click for grid/custom placement.">
                    Planted Col</button>
                <button class="tool-btn" id="colAlignBtn" onclick="toggleColumnAlignment()"
                    title="Toggle edge column alignment (Centered ↔ Flush to Grid)">Col: Center</button>
            </div>
            <div class="canvas-wrapper">
                <canvas id="mainCanvas"></canvas>
                <!-- v2.4: 3D Container -->
                <div id="container3D"></div>
            </div>
        </div>

        <!-- ========== RIGHT PANEL: RESULTS ========== -->
        <div class="panel">
            <div class="panel-header">Results</div>

            <!-- Compact Results Table (Paper Matte style) -->
            <div class="results-table-container" style="overflow-x:auto; margin-top:8px; border: 1px solid #000;">
                <table class="compact-table"
                    style="width:100%; border-collapse: collapse; font-family: monospace; font-size: 0.75rem; color: #000;">
                    <tr style="border-bottom: 2px solid #000; background: #e8eef4;">
                        <th style="text-align:left; padding:6px; font-weight:bold;">METRIC</th>
                        <th style="text-align:right; padding:6px; font-weight:bold;">VALUE</th>
                        <th style="text-align:left; padding:6px; font-weight:bold;">UNIT</th>
                    </tr>
                    <tr style="border-bottom: 1px solid #ccc;">
                        <td style="padding:4px;">TOTAL SLAB AREA</td>
                        <td style="text-align:right; padding:4px; font-weight:bold;" id="totalArea">0</td>
                        <td style="padding:4px;">m²</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ccc;">
                        <td style="padding:4px;">AREA BALANCE</td>
                        <td style="text-align:right; padding:4px;" id="areaBalance">0%</td>
                        <td style="padding:4px; font-size:0.65rem;" id="areaBalanceDetail">beam vs slab</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ccc;">
                        <td style="padding:4px;">FACTORED LOAD</td>
                        <td style="text-align:right; padding:4px;" id="factoredLoad">0</td>
                        <td style="padding:4px;">kPa</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ccc;">
                        <td style="padding:4px;">TOTAL/FLOOR</td>
                        <td style="text-align:right; padding:4px;" id="totalPerFloor">0</td>
                        <td style="padding:4px;">kN</td>
                    </tr>
                    <tr style="border-bottom: 2px solid #000;">
                        <td style="padding:4px;">MAX COLUMN</td>
                        <td style="text-align:right; padding:4px;" id="maxColumn">0</td>
                        <td style="padding:4px;">kN</td>
                    </tr>

                    <!-- Load Summary Header -->
                    <tr style="background:#000; color:#fff;">
                        <td colspan="3" style="padding:6px; font-weight:bold; letter-spacing:1px; text-align:center;">
                            LOAD SUMMARY</td>
                    </tr>

                    <tr style="border-bottom: 1px solid #ccc;">
                        <td style="padding:4px;">SLAB DL</td>
                        <td style="text-align:right; padding:4px;" id="sumSlabDL">-</td>
                        <td style="padding:4px;">kN</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ccc;">
                        <td style="padding:4px;">LIVE LOAD</td>
                        <td style="text-align:right; padding:4px;" id="sumLL">-</td>
                        <td style="padding:4px;">kN</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ccc;">
                        <td style="padding:4px;">BEAM DL</td>
                        <td style="text-align:right; padding:4px;" id="sumBeamDL">-</td>
                        <td style="padding:4px;">kN</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ccc;">
                        <td style="padding:4px;">COLUMN DL</td>
                        <td style="text-align:right; padding:4px;" id="sumColDL">-</td>
                        <td style="padding:4px;">kN</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ccc;">
                        <td style="padding:4px;">TIE BEAM</td>
                        <td style="text-align:right; padding:4px;" id="sumTieBeamDL">-</td>
                        <td style="padding:4px;">kN</td>
                    </tr>
                    <tr style="border-bottom: 2px solid #000;">
                        <td style="padding:4px;">FOOTINGS</td>
                        <td style="text-align:right; padding:4px;" id="sumFootingDL">-</td>
                        <td style="padding:4px;">kN</td>
                    </tr>
                    <!-- Grand Total -->
                    <tr style="background:#f8fafc; font-weight:bold;">
                        <td style="padding:8px; border-right:1px solid #000;">GRAND TOTAL</td>
                        <td style="text-align:right; padding:8px; font-size:1rem;" id="grandTotal">-</td>
                        <td style="padding:8px;">kN</td>
                    </tr>
                </table>
            </div>

            <!-- Column Results Table -->
            <div class="param-group">
                <h3>Column Loads & Footings</h3>
                <div style="max-height: 300px; overflow-y: auto;">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th title="Toggle to remove column (L/U shapes)">✓</th>
                                <th>ID</th>
                                <th>Type</th>
                                <th title="v3.0: Set column start floor (planted columns)">Start</th>
                                <th>Floor (kN)</th>
                                <th>Total (kN)</th>
                                <th title="Load breakdown">📊</th>
                                <th>Size (mm)</th>
                                <th>Footing (m)</th>
                            </tr>
                        </thead>
                        <tbody id="columnResultsBody">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Beam Results -->
            <div class="param-group">
                <h3>📏 Beam Loads</h3>
                <div style="max-height: 200px; overflow-y: auto;">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Beam</th>
                                <th>w (kN/m)</th>
                                <th>R (kN)</th>
                                <th>b×h (mm)</th>
                            </tr>
                        </thead>
                        <tbody id="beamResultsBody">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- v3.2: Footing Schedule -->
            <div class="param-group">
                <h3>🧱 Footing Schedule</h3>
                <div style="max-height: 180px; overflow-y: auto;">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Footing</th>
                                <th>Column</th>
                                <th>Size (m)</th>
                                <th>Thk (mm)</th>
                            </tr>
                        </thead>
                        <tbody id="footingScheduleBody">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- v3.2: Tie Beam Schedule -->
            <div class="param-group">
                <h3>🔗 Tie Beam Size</h3>
                <div style="display:flex;gap:12px;align-items:center;">
                    <label>Width (mm):
                        <input type="number" id="tieBeamWidth" value="200" min="150" max="400" step="25"
                            style="width:60px;padding:4px;background:rgba(0,0,0,0.3);border:1px solid var(--border);border-radius:4px;color:white;text-align:center;"
                            onchange="updateTieBeamSize()">
                    </label>
                    <label>Depth (mm):
                        <input type="number" id="tieBeamDepth" value="350" min="250" max="600" step="50"
                            style="width:60px;padding:4px;background:rgba(0,0,0,0.3);border:1px solid var(--border);border-radius:4px;color:white;text-align:center;"
                            onchange="updateTieBeamSize()">
                    </label>
                </div>
                <p style="font-size:0.6rem;color:#8b949e;margin-top:4px;">Min: 200×350mm (NBC)</p>
            </div>

            <!-- v3.2: Member Dimensions table removed - size controls now in individual schedules -->

            <!-- v3.0: Concrete Volume Summary -->
            <div class="param-group">
                <h3>🧱 Concrete Volume</h3>
                <div id="concreteVolumeSection" style="font-size:0.75rem;">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Element</th>
                                <th>Qty</th>
                                <th>Volume (m³)</th>
                            </tr>
                        </thead>
                        <tbody id="concreteVolumeBody">
                            <!-- Dynamic content -->
                        </tbody>
                        <tfoot>
                            <tr style="background:rgba(16,185,129,0.15);font-weight:bold;">
                                <td colspan="2">TOTAL</td>
                                <td id="totalConcreteVolume">-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- v3.0: Schedules Button -->
            <div class="param-group" style="text-align:center;">
                <button onclick="showSchedulesModal()" style="
                    width: 100%;
                    padding: 12px;
                    background: linear-gradient(135deg, #6366f1, #8b5cf6);
                    border: none;
                    border-radius: 8px;
                    color: white;
                    font-weight: bold;
                    cursor: pointer;
                    font-size: 0.9rem;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                ">📋 View Schedules</button>
            </div>
        </div>
    </div>

    <!-- v3.0: Custom Beam Modal Dialog -->
    <div id="customBeamModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; justify-content:center; align-items:center;">
        <div
            style="background:linear-gradient(135deg,#1e293b,#0f172a); border:1px solid rgba(255,255,255,0.2); border-radius:12px; padding:24px; min-width:320px; box-shadow:0 20px 40px rgba(0,0,0,0.5);">
            <h3 style="color:#00d4ff; margin:0 0 16px 0; display:flex; align-items:center; gap:8px;">🪜 Add Custom Beam
            </h3>

            <div style="margin-bottom:12px;">
                <label style="display:block; font-size:0.75rem; color:#8b949e; margin-bottom:4px;">Direction</label>
                <select id="cbDir"
                    style="width:100%; padding:8px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white;">
                    <option value="X">X-Direction (Horizontal beam at Y position)</option>
                    <option value="Y">Y-Direction (Vertical beam at X position)</option>
                </select>
            </div>

            <div style="margin-bottom:12px;">
                <label style="display:block; font-size:0.75rem; color:#8b949e; margin-bottom:4px;">Reference
                    Gridline</label>
                <select id="cbRefGridline"
                    style="width:100%; padding:8px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white;">
                    <!-- Populated dynamically -->
                </select>
            </div>

            <div style="margin-bottom:12px;">
                <label style="display:block; font-size:0.75rem; color:#8b949e; margin-bottom:4px;">Offset from Gridline
                    (m)</label>
                <input type="number" id="cbOffset" value="1.5" step="0.1" min="0.1"
                    style="width:100%; padding:8px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white;">
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:16px;">
                <div>
                    <label style="display:block; font-size:0.75rem; color:#8b949e; margin-bottom:4px;">From Span</label>
                    <select id="cbFromSpan"
                        style="width:100%; padding:8px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white;">
                        <!-- Populated dynamically -->
                    </select>
                </div>
                <div>
                    <label style="display:block; font-size:0.75rem; color:#8b949e; margin-bottom:4px;">To Span</label>
                    <select id="cbToSpan"
                        style="width:100%; padding:8px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white;">
                        <!-- Populated dynamically -->
                    </select>
                </div>
            </div>

            <div
                style="font-size:0.7rem; color:#f59e0b; background:rgba(245,158,11,0.1); padding:8px; border-radius:6px; margin-bottom:16px;">
                💡 Beam will be placed perpendicular to the chosen direction, at the offset distance from the reference
                gridline.
            </div>

            <div style="display:flex; gap:8px;">
                <button onclick="hideCustomBeamDialog()"
                    style="flex:1; padding:10px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:#8b949e; cursor:pointer;">Cancel</button>
                <button onclick="addCustomBeam()"
                    style="flex:1; padding:10px; background:linear-gradient(135deg,#f59e0b,#d97706); border:none; border-radius:6px; color:white; font-weight:600; cursor:pointer;">Add
                    Beam</button>
            </div>
        </div>
    </div>

    <!-- v3.0: Planted Column Modal Dialog -->
    <div id="plantedColumnModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; justify-content:center; align-items:center;">
        <div
            style="background:linear-gradient(135deg,#1e293b,#0f172a); border:1px solid rgba(255,255,255,0.2); border-radius:12px; padding:24px; min-width:360px; box-shadow:0 20px 40px rgba(0,0,0,0.5);">
            <h3 style="color:#8b5cf6; margin:0 0 16px 0; display:flex; align-items:center; gap:8px;">⏫ Add Planted
                Column
            </h3>

            <!-- v3.0: Placement Mode Toggle -->
            <div
                style="display:flex; gap:4px; margin-bottom:16px; background:rgba(0,0,0,0.3); padding:4px; border-radius:8px;">
                <button id="pcModeGrid" onclick="setPCPlacementMode('grid')"
                    style="flex:1; padding:8px; border:none; border-radius:6px; cursor:pointer; font-size:0.75rem; font-weight:600; background:linear-gradient(135deg,#8b5cf6,#6366f1); color:white;">
                    📍 Grid Location
                </button>
                <button id="pcModeCustom" onclick="setPCPlacementMode('custom')"
                    style="flex:1; padding:8px; border:none; border-radius:6px; cursor:pointer; font-size:0.75rem; font-weight:600; background:transparent; color:#8b949e;">
                    📐 Custom X,Y
                </button>
            </div>

            <!-- Grid Location Mode -->
            <div id="pcGridSection" style="margin-bottom:12px;">
                <label style="display:block; font-size:0.75rem; color:#8b949e; margin-bottom:4px;">Grid Location</label>
                <select id="pcGridLocation"
                    style="width:100%; padding:8px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white;">
                    <!-- Populated dynamically -->
                </select>
            </div>

            <!-- Custom X,Y Mode (hidden by default) -->
            <div id="pcCustomSection" style="display:none; margin-bottom:12px;">
                <label style="display:block; font-size:0.75rem; color:#8b949e; margin-bottom:4px;">📐 Custom Coordinates
                    (meters from origin)</label>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                    <div>
                        <label style="font-size:0.65rem; color:#6366f1;">X (m)</label>
                        <input type="number" id="pcCustomX" value="0" step="0.1" min="0"
                            style="width:100%; padding:8px; background:rgba(0,0,0,0.3); border:1px solid rgba(139,92,246,0.4); border-radius:6px; color:white;"
                            placeholder="X coord">
                    </div>
                    <div>
                        <label style="font-size:0.65rem; color:#6366f1;">Y (m)</label>
                        <input type="number" id="pcCustomY" value="0" step="0.1" min="0"
                            style="width:100%; padding:8px; background:rgba(0,0,0,0.3); border:1px solid rgba(139,92,246,0.4); border-radius:6px; color:white;"
                            placeholder="Y coord">
                    </div>
                </div>
                <div style="font-size:0.65rem; color:#8b949e; margin-top:4px;">💡 Tip: Click on canvas to auto-fill
                    coordinates!</div>
            </div>

            <div style="margin-bottom:12px;">
                <label style="display:block; font-size:0.75rem; color:#8b949e; margin-bottom:4px;">Starting Floor
                    (Column appears from this floor upward)</label>
                <select id="pcStartFloor"
                    style="width:100%; padding:8px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white;">
                    <!-- Populated dynamically -->
                </select>
            </div>

            <div style="margin-bottom:16px;">
                <label style="display:block; font-size:0.75rem; color:#8b949e; margin-bottom:4px;">Column Size
                    (mm)</label>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                    <input type="number" id="pcWidthB" value="300" min="200" max="1000" step="50"
                        style="padding:8px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white;"
                        placeholder="Width (b)">
                    <input type="number" id="pcDepthH" value="300" min="200" max="1000" step="50"
                        style="padding:8px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white;"
                        placeholder="Depth (h)">
                </div>
            </div>

            <div
                style="font-size:0.7rem; color:#8b5cf6; background:rgba(139,92,246,0.1); padding:8px; border-radius:6px; margin-bottom:16px;">
                💡 A planted column starts from an upper floor (e.g., 2F) instead of the ground. It transfers load to
                beams below.
            </div>

            <div style="display:flex; gap:8px;">
                <button onclick="hidePlantedColumnDialog()"
                    style="flex:1; padding:10px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:#8b949e; cursor:pointer;">Cancel</button>
                <button onclick="addPlantedColumn()"
                    style="flex:1; padding:10px; background:linear-gradient(135deg,#8b5cf6,#6366f1); border:none; border-radius:6px; color:white; font-weight:600; cursor:pointer;">Add
                    Column</button>
            </div>
        </div>
    </div>

    <!-- v3.0: Beam Offset Dialog for Planted Column Placement -->
    <div id="beamOffsetModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1002; justify-content:center; align-items:center;">
        <div
            style="background:linear-gradient(135deg,#1e293b,#0f172a); border:1px solid rgba(139,92,246,0.5); border-radius:12px; padding:24px; min-width:320px; box-shadow:0 20px 40px rgba(139,92,246,0.2);">
            <h3 style="color:#8b5cf6; margin:0 0 16px 0; display:flex; align-items:center; gap:8px;">⏫ Place Column on
                Beam</h3>

            <!-- Beam Info -->
            <div style="background:rgba(0,0,0,0.3); padding:12px; border-radius:8px; margin-bottom:16px;">
                <div style="font-size:0.7rem; color:#8b949e; margin-bottom:4px;">Selected Beam:</div>
                <div id="pcBeamInfo" style="color:#00d4ff; font-weight:bold;">-</div>
            </div>

            <!-- Offset Input -->
            <div style="margin-bottom:12px;">
                <label style="display:block; font-size:0.75rem; color:#8b949e; margin-bottom:4px;">
                    Offset from Start (m) <span id="pcOffsetDirection" style="color:#f59e0b;">→</span>
                </label>
                <input type="number" id="pcBeamOffset" value="1.0" step="0.1" min="0.1"
                    style="width:100%; padding:10px; background:rgba(0,0,0,0.3); border:1px solid rgba(139,92,246,0.5); border-radius:6px; color:white; font-size:1rem;">
                <div id="pcOffsetRange" style="font-size:0.65rem; color:#8b949e; margin-top:4px;">Range: 0.1 - 8.0 m
                </div>
            </div>

            <!-- Start Floor -->
            <div style="margin-bottom:12px;">
                <label style="display:block; font-size:0.75rem; color:#8b949e; margin-bottom:4px;">Start Floor</label>
                <select id="pcBeamStartFloor"
                    style="width:100%; padding:8px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white;">
                    <!-- Populated dynamically -->
                </select>
            </div>

            <!-- Column Size -->
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:16px;">
                <div>
                    <label style="display:block; font-size:0.75rem; color:#8b949e; margin-bottom:4px;">Width b
                        (mm)</label>
                    <input type="number" id="pcBeamColB" value="250" step="50" min="150" max="600"
                        style="width:100%; padding:8px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white;">
                </div>
                <div>
                    <label style="display:block; font-size:0.75rem; color:#8b949e; margin-bottom:4px;">Depth h
                        (mm)</label>
                    <input type="number" id="pcBeamColH" value="250" step="50" min="150" max="600"
                        style="width:100%; padding:8px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white;">
                </div>
            </div>

            <div
                style="font-size:0.7rem; color:#f59e0b; background:rgba(245,158,11,0.1); padding:8px; border-radius:6px; margin-bottom:16px;">
                💡 Column will be placed as a <strong>point load</strong> on this beam
            </div>

            <div style="display:flex; gap:8px;">
                <button onclick="hideBeamOffsetDialog()"
                    style="flex:1; padding:10px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:#8b949e; cursor:pointer;">Cancel</button>
                <button onclick="placePlantedColumnOnBeam()"
                    style="flex:1; padding:10px; background:linear-gradient(135deg,#8b5cf6,#6366f1); border:none; border-radius:6px; color:white; font-weight:600; cursor:pointer;">Place
                    Column</button>
            </div>
        </div>
    </div>

    <!-- v3.0: Column Context Menu (appears on column click) -->
    <div id="columnContextMenu"
        style="display:none; position:fixed; background:linear-gradient(135deg,#1e293b,#0f172a); border:1px solid rgba(255,255,255,0.2); border-radius:8px; padding:8px 0; min-width:180px; box-shadow:0 10px 30px rgba(0,0,0,0.5); z-index:1001;">
        <div id="columnMenuTitle"
            style="padding:8px 16px; color:#00d4ff; font-weight:bold; border-bottom:1px solid rgba(255,255,255,0.1); margin-bottom:4px;">
            Column A1</div>
        <button class="ctx-menu-btn" onclick="toggleSelectedColumn()">🔄 Toggle Active</button>
        <div style="border-top:1px solid rgba(255,255,255,0.1); margin:4px 0;"></div>
        <div style="padding:4px 16px; font-size:0.7rem; color:#8b949e;">Set as Planted Column:</div>
        <div id="plantedFloorOptions">
            <!-- Populated dynamically -->
        </div>
        <button class="ctx-menu-btn" onclick="clearPlantedFloor()" style="color:#ef4444;">🚫 Clear Planted
            (Ground)</button>
    </div>

    <!-- v3.2: Universal Member Context Menu (right-click on beams/slabs) -->
    <div id="memberContextMenu"
        style="display:none; position:fixed; background:linear-gradient(135deg,#1e293b,#0f172a); border:1px solid rgba(255,255,255,0.2); border-radius:8px; padding:8px 0; min-width:160px; box-shadow:0 10px 30px rgba(0,0,0,0.5); z-index:1001;">
        <div id="memberMenuTitle"
            style="padding:8px 16px; color:#00d4ff; font-weight:bold; border-bottom:1px solid rgba(255,255,255,0.1); margin-bottom:4px;">
            Beam B-1</div>
        <button class="ctx-menu-btn" onclick="deleteMemberFromMenu()" style="color:#ef4444;">🗑️ Delete</button>
        <button class="ctx-menu-btn" id="memberLockBtn" onclick="toggleMemberLocked()" style="color:#f59e0b;">🔒
            Lock</button>
        <button class="ctx-menu-btn" onclick="restoreMemberFromMenu()" style="color:#10b981;">♻️ Restore</button>
        <button class="ctx-menu-btn" onclick="hideMemberMenu()">❌ Cancel</button>
    </div>

    <!-- v3.0: Schedules Modal -->
    <div id="schedulesModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; justify-content:center; align-items:center;">
        <div
            style="background:linear-gradient(135deg,#1e293b,#0f172a); border:1px solid rgba(255,255,255,0.2); border-radius:12px; padding:24px; width:90%; max-width:900px; max-height:80vh; overflow:hidden; box-shadow:0 20px 40px rgba(0,0,0,0.5);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <h3 style="color:#00d4ff; margin:0; display:flex; align-items:center; gap:8px;">📋 Beam & Column
                    Schedules</h3>
                <button onclick="hideSchedulesModal()"
                    style="background:none; border:none; color:#8b949e; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>

            <!-- Tabs -->
            <div style="display:flex; gap:8px; margin-bottom:16px;">
                <button id="schedTabBeams" class="sched-tab active" onclick="switchScheduleTab('beams')">📏
                    Beams</button>
                <button id="schedTabColumns" class="sched-tab" onclick="switchScheduleTab('columns')">🏛️
                    Columns</button>
            </div>

            <!-- Beam Schedule -->
            <div id="scheduleBeamsPanel" style="max-height:50vh; overflow:auto;">
                <table class="results-table" style="width:100%;">
                    <thead>
                        <tr>
                            <th>Beam ID</th>
                            <th>Dir</th>
                            <th>Span (m)</th>
                            <th>Size (mm)</th>
                            <th>Start Col</th>
                            <th>End Col</th>
                            <th>w (kN/m)</th>
                            <th>R (kN)</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBeamsBody">
                        <!-- Dynamic -->
                    </tbody>
                </table>
            </div>

            <!-- Column Schedule -->
            <div id="scheduleColumnsPanel" style="display:none; max-height:50vh; overflow:auto;">
                <table class="results-table" style="width:100%;">
                    <thead>
                        <tr>
                            <th>Col ID</th>
                            <th>Type</th>
                            <th>Size (mm)</th>
                            <th>Total Load (kN)</th>
                            <th>Footing (m)</th>
                            <th>Planted?</th>
                            <th>Floors Active</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleColumnsBody">
                        <!-- Dynamic -->
                    </tbody>
                </table>
            </div>

            <div style="display:flex; gap:8px; margin-top:16px;">
                <button onclick="exportScheduleCSV()"
                    style="flex:1; padding:10px; background:linear-gradient(135deg,#10b981,#059669); border:none; border-radius:6px; color:white; cursor:pointer; font-weight:bold;">📥
                    Export CSV</button>
                <button onclick="hideSchedulesModal()"
                    style="flex:1; padding:10px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:#8b949e; cursor:pointer;">Close</button>
            </div>
        </div>
    </div>

    <style>
        /* Column context menu button styles */
        .ctx-menu-btn {
            display: block;
            width: 100%;
            padding: 8px 16px;
            background: none;
            border: none;
            color: #e2e8f0;
            text-align: left;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .ctx-menu-btn:hover {
            background: rgba(99, 102, 241, 0.2);
        }

        /* Schedule tab styles */
        .sched-tab {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #8b949e;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .sched-tab.active {
            background: rgba(99, 102, 241, 0.3);
            border-color: #6366f1;
            color: #e2e8f0;
        }
    </style>


    <!-- ========== JAVASCRIPT ========== -->
    <script src="./js/app.js"></script>

    <!-- ========== RESIDENT ETHOS AI ASSISTANT ========== -->
    <style>
        /* Floating Action Button - Modern Glowing Entity */
        .ethos-fab {
            position: fixed;
            bottom: 60px;
            right: 24px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            /* Glassmorphism + Glow */
            background: rgba(124, 58, 237, 0.15);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(124, 58, 237, 0.3);
            color: #a78bfa;
            font-size: 26px;
            cursor: pointer;
            /* Multi-layer glow effect */
            box-shadow:
                0 0 20px rgba(124, 58, 237, 0.4),
                0 0 40px rgba(79, 70, 229, 0.2),
                0 0 60px rgba(139, 92, 246, 0.1),
                inset 0 0 20px rgba(167, 139, 250, 0.1);
            z-index: 9999;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            /* Pulsing animation */
            animation: ethosGlow 3s ease-in-out infinite;
        }

        @keyframes ethosGlow {

            0%,
            100% {
                box-shadow:
                    0 0 20px rgba(124, 58, 237, 0.4),
                    0 0 40px rgba(79, 70, 229, 0.2),
                    0 0 60px rgba(139, 92, 246, 0.1),
                    inset 0 0 20px rgba(167, 139, 250, 0.1);
                transform: scale(1);
            }

            50% {
                box-shadow:
                    0 0 30px rgba(124, 58, 237, 0.6),
                    0 0 60px rgba(79, 70, 229, 0.3),
                    0 0 80px rgba(139, 92, 246, 0.2),
                    inset 0 0 30px rgba(167, 139, 250, 0.15);
                transform: scale(1.05);
            }
        }

        .ethos-fab:hover {
            transform: scale(1.15);
            background: rgba(124, 58, 237, 0.25);
            box-shadow:
                0 0 40px rgba(124, 58, 237, 0.7),
                0 0 80px rgba(79, 70, 229, 0.4),
                0 0 100px rgba(139, 92, 246, 0.3),
                inset 0 0 30px rgba(167, 139, 250, 0.2);
            animation: none;
        }

        .ethos-fab.hidden {
            transform: scale(0);
            opacity: 0;
            pointer-events: none;
        }

        /* Panel */
        .ethos-panel {
            position: fixed;
            bottom: 60px;
            right: 24px;
            width: 380px;
            height: 480px;
            background: var(--panel-bg, #161b22);
            border: 1px solid var(--border, #21262d);
            border-radius: 16px;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.4);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .ethos-panel.open {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: all;
        }

        .ethos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(135deg, #7c3aed, #4f46e5);
            border-radius: 16px 16px 0 0;
            color: white;
        }

        .ethos-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .ethos-controls {
            display: flex;
            gap: 4px;
        }

        .ethos-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 6px 8px;
            border-radius: 6px;
            cursor: pointer;
            color: white;
            font-size: 14px;
        }

        .ethos-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .ethos-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .ethos-welcome {
            background: var(--glass, rgba(0, 0, 0, 0.2));
            padding: 12px;
            border-radius: 12px;
            color: var(--text-muted, #8b949e);
            font-size: 13px;
        }

        .ethos-message {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .ethos-message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #7c3aed, #4f46e5);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .ethos-message.assistant {
            align-self: flex-start;
            background: var(--glass, rgba(0, 0, 0, 0.3));
            color: var(--text-primary, #e6edf3);
            border-bottom-left-radius: 4px;
        }

        .ethos-message.error {
            background: #dc2626;
            color: white;
        }

        .ethos-message.loading {
            color: var(--text-muted, #8b949e);
        }

        .ethos-message.loading::after {
            content: '...';
            animation: dots 1s infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60%,
            100% {
                content: '...';
            }
        }

        .ethos-input-area {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            border-top: 1px solid var(--border, #21262d);
        }

        #ethosInput {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border, #21262d);
            border-radius: 8px;
            background: var(--glass, rgba(0, 0, 0, 0.3));
            color: var(--text-primary, #e6edf3);
            font-size: 14px;
        }

        #ethosInput:focus {
            outline: none;
            border-color: #7c3aed;
        }

        .ethos-send-btn {
            padding: 10px 16px;
            background: linear-gradient(135deg, #7c3aed, #4f46e5);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }

        .ethos-send-btn:disabled {
            opacity: 0.5;
        }

        .ethos-api-setup {
            padding: 16px;
            background: var(--glass, rgba(0, 0, 0, 0.2));
            border-top: 1px solid var(--border, #21262d);
            text-align: center;
        }

        .ethos-api-setup p {
            margin: 8px 0;
            color: var(--text-muted, #8b949e);
            font-size: 13px;
        }

        .ethos-api-setup input {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid var(--border, #21262d);
            border-radius: 6px;
            background: var(--glass-darker, rgba(0, 0, 0, 0.3));
            color: var(--text-primary, #e6edf3);
        }

        .ethos-api-setup button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #7c3aed, #4f46e5);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
        }

        .ethos-hint a {
            color: #7c3aed;
        }
    </style>

    <!-- Resident Ethos UI -->
    <button id="ethosFab" class="ethos-fab" title="Resident Ethos - AI Assistant">AI</button>
    <div id="ethosPanel" class="ethos-panel">
        <div class="ethos-header">
            <div class="ethos-title"><span>🤖</span><span>Resident Ethos</span></div>
            <div class="ethos-controls">
                <button class="ethos-btn" id="ethosClear" title="Clear">🗑️</button>
                <button class="ethos-btn" id="ethosSettings" title="Settings">⚙️</button>
                <button class="ethos-btn" id="ethosClose" title="Close">✕</button>
            </div>
        </div>
        <div class="ethos-messages" id="ethosMessages">
            <div class="ethos-welcome">
                <p>👋 Hello! I'm <strong>Resident Ethos</strong>, your AI structural engineering assistant.</p>
                <p>Ask me about your structure, NSCP code, or calculations!</p>
            </div>
        </div>
        <div class="ethos-input-area" id="ethosInputArea">
            <input type="text" id="ethosInput" placeholder="Ask about your structure..." />
            <button id="ethosSend" class="ethos-send-btn">➤</button>
        </div>
        <div class="ethos-api-setup" id="ethosApiSetup" style="display:none;">
            <p>🔑 Enter your Gemini API key:</p>
            <input type="password" id="ethosApiKeyInput" placeholder="AIza..." />
            <button id="ethosApiKeySave">Save Key</button>
            <p class="ethos-hint">Get a free key at <a href="https://aistudio.google.com/apikey" target="_blank">AI
                    Studio</a></p>
        </div>
    </div>

    <script>
        // ========== RESIDENT ETHOS ENGINE ==========
        const ETHOS = {
            apiKey: localStorage.getItem('residentEthosApiKey'),
            history: [],
            isLoading: false,

            SYSTEM_PROMPT: `You are Resident Ethos, an AI structural engineering assistant in Tributary Pro v3.0.
Tributary Pro calculates column loads, beam reactions, and footing sizes per NSCP 2015 (Philippines).

You can access the current project state. Be concise, technical, use engineering terms.
Reference NSCP sections when applicable. Format numbers with units (kN, mm, m).`,

            // Get project state
            getState() {
                return {
                    grid: { xSpans: state.xSpans, ySpans: state.ySpans },
                    floors: state.floors.map(f => ({ id: f.id, height: f.height, load: f.load })),
                    columns: state.columns.filter(c => c.active !== false).length,
                    settings: { fc: state.fc, fy: state.fy, sbc: state.sbc }
                };
            },

            getColumnLoads() {
                return state.columns.filter(c => c.active !== false).map(c => ({
                    id: c.id, type: c.type,
                    load: c.totalLoad ? c.totalLoad.toFixed(1) + ' kN' : 'N/A',
                    size: c.suggestedB ? `${c.suggestedB}x${c.suggestedH} mm` : 'N/A'
                }));
            },

            // ========== ACTION FUNCTIONS ==========

            setXSpans(values) {
                if (!Array.isArray(values)) return { success: false, error: 'values must be an array' };
                state.xSpans = values.map(v => parseFloat(v));
                if (typeof renderSpans === 'function') renderSpans();
                if (typeof calculate === 'function') calculate();
                return { success: true, message: `✅ Set ${state.xSpans.length} X-spans: ${state.xSpans.join('m, ')}m` };
            },

            setYSpans(values) {
                if (!Array.isArray(values)) return { success: false, error: 'values must be an array' };
                state.ySpans = values.map(v => parseFloat(v));
                if (typeof renderSpans === 'function') renderSpans();
                if (typeof calculate === 'function') calculate();
                return { success: true, message: `✅ Set ${state.ySpans.length} Y-spans: ${state.ySpans.join('m, ')}m` };
            },

            setFloorCount(count) {
                const target = parseInt(count);
                if (target < 1 || target > 10) return { success: false, error: 'Floor count must be 1-10' };
                while (state.floors.length < target) { if (typeof addFloor === 'function') addFloor(); else break; }
                while (state.floors.length > target) { if (typeof removeFloor === 'function') removeFloor(); else break; }
                return { success: true, message: `✅ Set to ${state.floors.length} floors` };
            },

            runCalculation() {
                if (typeof calculate === 'function') {
                    calculate();
                    const maxLoad = state.columns.length > 0
                        ? Math.max(...state.columns.filter(c => c.active !== false).map(c => c.totalLoad || 0))
                        : 0;
                    return { success: true, message: `✅ Calculation complete!\n📊 Max column load: ${maxLoad.toFixed(1)} kN\n🏛️ Active columns: ${state.columns.filter(c => c.active !== false).length}` };
                }
                return { success: false, error: 'calculate function not available' };
            },

            exportProject(format) {
                const fmt = format.toUpperCase();
                if (fmt === 'STAAD' && typeof exportToSTAAD === 'function') {
                    exportToSTAAD();
                    return { success: true, message: '✅ Exported to STAAD format (download started)' };
                } else if (fmt === 'ETABS' && typeof exportToETABS === 'function') {
                    exportToETABS();
                    return { success: true, message: '✅ Exported to ETABS format (download started)' };
                }
                return { success: false, error: `Unknown format: ${format}. Use STAAD or ETABS.` };
            },

            setLiveLoad(value) {
                const ll = parseFloat(value);
                if (isNaN(ll) || ll < 0 || ll > 20) return { success: false, error: 'Live load must be 0-20 kPa' };
                state.LL = ll;
                const llInput = document.getElementById('LL');
                if (llInput) llInput.value = ll;
                if (typeof calculate === 'function') calculate();
                return { success: true, message: `✅ Live load set to ${ll} kPa` };
            },

            // ========== COMMAND PARSER ==========
            parseCommand(msg) {
                const lower = msg.toLowerCase();

                // Set X spans: "set x spans to 4, 5, 4" or "x spans 4m 5m 4m"
                let match = lower.match(/(?:set\s+)?x\s*spans?\s*(?:to\s+)?([\d.,\s]+)/);
                if (match) {
                    const values = match[1].split(/[\s,]+/).map(v => parseFloat(v.replace('m', ''))).filter(v => !isNaN(v) && v > 0);
                    if (values.length > 0) return this.setXSpans(values);
                }

                // Set Y spans
                match = lower.match(/(?:set\s+)?y\s*spans?\s*(?:to\s+)?([\d.,\s]+)/);
                if (match) {
                    const values = match[1].split(/[\s,]+/).map(v => parseFloat(v.replace('m', ''))).filter(v => !isNaN(v) && v > 0);
                    if (values.length > 0) return this.setYSpans(values);
                }

                // Set floor count: "set to 4 floors" or "4 floors" or "add 3 floors"
                match = lower.match(/(\d+)\s*(?:storeys?|floors?)/);
                if (match && (lower.includes('set') || lower.includes('make') || lower.includes('floors'))) {
                    return this.setFloorCount(parseInt(match[1]));
                }

                // Calculate: "calculate" or "run calculation"
                if (lower.includes('calculate') || lower.includes('run calc') || lower.includes('compute')) {
                    return this.runCalculation();
                }

                // Export: "export to staad" or "staad export"
                if (lower.includes('export') && lower.includes('staad')) {
                    return this.exportProject('STAAD');
                }
                if (lower.includes('export') && lower.includes('etabs')) {
                    return this.exportProject('ETABS');
                }

                // Set live load: "set live load to 2.4" or "LL 2.4 kpa"
                match = lower.match(/(?:set\s+)?(?:live\s*load|ll)\s*(?:to\s+)?([\d.]+)/);
                if (match) {
                    return this.setLiveLoad(parseFloat(match[1]));
                }

                return null; // No command matched
            },

            // Chat with Gemini
            async chat(message) {
                if (!this.apiKey) return { success: false, error: 'API key not set' };

                // v3.0: Check for action commands FIRST
                const cmdResult = this.parseCommand(message);
                if (cmdResult) {
                    this.history.push({ role: 'user', parts: [{ text: message }] });
                    this.history.push({ role: 'model', parts: [{ text: cmdResult.message || cmdResult.error }] });
                    return cmdResult;
                }

                this.history.push({ role: 'user', parts: [{ text: message }] });

                // Check for local queries
                const lower = message.toLowerCase();
                if (lower.includes('span') || lower.includes('grid')) {
                    const s = this.getState();
                    return {
                        success: true, message:
                            `📏 **Current Grid:**\n- X Spans: ${s.grid.xSpans.join(', ')} m\n- Y Spans: ${s.grid.ySpans.join(', ')} m\n- Total X: ${s.grid.xSpans.reduce((a, b) => a + b, 0).toFixed(1)} m\n- Total Y: ${s.grid.ySpans.reduce((a, b) => a + b, 0).toFixed(1)} m`
                    };
                }
                if (lower.includes('column') && lower.includes('load')) {
                    const cols = this.getColumnLoads().slice(0, 8);
                    return {
                        success: true, message:
                            `🏗️ **Column Loads (first 8):**\n${cols.map(c => `- ${c.id}: ${c.load} → ${c.size}`).join('\n')}`
                    };
                }
                if (lower.includes('floor') || lower.includes('storey')) {
                    const s = this.getState();
                    return {
                        success: true, message:
                            `🏢 **Floors:** ${s.floors.length}\n${s.floors.map(f => `- ${f.id}: H=${f.height}m, Load=${f.load} kN/m²`).join('\n')}`
                    };
                }

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${this.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            system_instruction: { parts: [{ text: this.SYSTEM_PROMPT + '\n\nCurrent State: ' + JSON.stringify(this.getState()) }] },
                            contents: this.history
                        })
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error?.message || 'API error');
                    }

                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No response';

                    this.history.push({ role: 'model', parts: [{ text }] });
                    return { success: true, message: text };

                } catch (e) {
                    this.history.pop();
                    return { success: false, error: e.message };
                }
            }
        };

        // ========== UI LOGIC ==========
        document.addEventListener('DOMContentLoaded', () => {
            const fab = document.getElementById('ethosFab');
            const panel = document.getElementById('ethosPanel');
            const closeBtn = document.getElementById('ethosClose');
            const clearBtn = document.getElementById('ethosClear');
            const settingsBtn = document.getElementById('ethosSettings');
            const sendBtn = document.getElementById('ethosSend');
            const input = document.getElementById('ethosInput');
            const messages = document.getElementById('ethosMessages');
            const apiSetup = document.getElementById('ethosApiSetup');
            const inputArea = document.getElementById('ethosInputArea');
            const apiSaveBtn = document.getElementById('ethosApiKeySave');

            // Open/Close panel
            fab.onclick = () => { panel.classList.add('open'); fab.classList.add('hidden'); input.focus(); };
            closeBtn.onclick = () => { panel.classList.remove('open'); fab.classList.remove('hidden'); };

            // Clear chat
            clearBtn.onclick = () => {
                ETHOS.history = [];
                messages.innerHTML = '<div class="ethos-welcome"><p>👋 Chat cleared! How can I help?</p></div>';
            };

            // Settings
            settingsBtn.onclick = () => {
                apiSetup.style.display = 'block';
                inputArea.style.display = 'none';
            };

            // Save API key
            apiSaveBtn.onclick = () => {
                const key = document.getElementById('ethosApiKeyInput').value.trim();
                if (key) {
                    ETHOS.apiKey = key;
                    localStorage.setItem('residentEthosApiKey', key);
                    apiSetup.style.display = 'none';
                    inputArea.style.display = 'flex';
                    addMsg('assistant', '✅ API key saved! Ready to help.');
                }
            };

            // Check API key on load
            if (!ETHOS.apiKey) {
                apiSetup.style.display = 'block';
                inputArea.style.display = 'none';
            }

            // Send message
            const sendMessage = async () => {
                if (ETHOS.isLoading) return;
                const text = input.value.trim();
                if (!text) return;
                if (!ETHOS.apiKey) { settingsBtn.click(); return; }

                input.value = '';
                addMsg('user', text);

                ETHOS.isLoading = true;
                sendBtn.disabled = true;
                const loading = addMsg('loading', 'Thinking');

                const result = await ETHOS.chat(text);
                loading.remove();

                if (result.success) addMsg('assistant', result.message);
                else addMsg('error', '❌ ' + result.error);

                ETHOS.isLoading = false;
                sendBtn.disabled = false;
                input.focus();
            };

            sendBtn.onclick = sendMessage;
            input.onkeydown = (e) => { if (e.key === 'Enter') sendMessage(); };

            function addMsg(type, text) {
                const div = document.createElement('div');
                div.className = 'ethos-message ' + type;
                div.textContent = text;
                messages.appendChild(div);
                messages.scrollTop = messages.scrollHeight;
                return div;
            }

            console.log('🤖 Resident Ethos initialized');

            // v3.3: Hamburger Dropdown Logic
            window.toggleDropdown = function () {
                const dd = document.getElementById('settingsDropdown');
                if (dd) dd.classList.toggle('hidden');
            };

            // Close dropdown when clicking outside
            document.addEventListener('click', function (event) {
                const dd = document.getElementById('settingsDropdown');
                const btn = document.querySelector('.settings-gear');
                if (dd && !dd.classList.contains('hidden') && !dd.contains(event.target) && !btn.contains(event.target)) {
                    dd.classList.add('hidden');
                }
            });
        });
    </script>

    <!-- Attribution Footer -->

    <footer style="
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95));
        backdrop-filter: blur(10px);
        border-top: 1px solid rgba(99, 102, 241, 0.3);
        padding: 8px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.75rem;
        color: #94a3b8;
        z-index: 1000;
    ">
        <div style="display: flex; align-items: center; gap: 8px;">
            <span style="color: #6366f1; font-weight: 600;">Tributary Pro</span>
            <span style="opacity: 0.5;">|</span>
            <span>by <strong style="color: #f59e0b;">Engr. Michael D. Futol</strong> & <strong
                    style="color: #ec4899;">Kira Futol</strong></span>
        </div>
        <div style="display: flex; align-items: center; gap: 6px;">
            <span style="
                background: linear-gradient(135deg, #6366f1, #8b5cf6);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                font-weight: 600;
            ">Futol Ethical Technology Ecosystems</span>
            <span style="opacity: 0.5;">© 2024-2025</span>
        </div>
    </footer>
</body>

</html>